{%- set name = "criteo-sample-kubernetes" -%}
{%- set image = "gcr.io/alekseyv-scalableai-dev/alekseyv_criteo_custom_container:v1" -%}
{%- set has_eval = False -%}
{%- set has_tensorboard = False -%}
{%- set script = "trainer/trainer.py" -%}
{%- set port = 5000 -%}

{%- set replicas = {"worker": worker_replicas,
                    "ps": ps_replicas,
                    "evaluator": has_eval|int,
                    "tensorboard": has_tensorboard|int} -%}
{% set cmdline_arg_list = cmdline_args.split(" ") %}

{%- macro worker_hosts() -%}
  {%- for i in range(worker_replicas) -%}
    {%- if not loop.first -%},{%- endif -%}
    \"{{ name }}-worker-{{ i }}:{{ port }}\"
  {%- endfor -%}
{%- endmacro -%}

{%- macro ps_hosts() -%}
  {%- for i in range(ps_replicas) -%}
    {%- if not loop.first -%},{%- endif -%}
    \"{{ name }}-ps-{{ i }}:{{ port }}\"
  {%- endfor -%}
{%- endmacro -%}

{%- macro tf_config(task_type, task_id) -%}
{
  \"cluster\": {
    \"worker\": [{{ worker_hosts() }}]
    {%- if ps_replicas > 0 -%}, \"ps\": [{{ ps_hosts() }}]{%- endif -%}
    {%- if has_eval -%},
    \"evaluator\": [\"{{ name }}-evaluator-0:{{ port }}\"]{%- endif -%}
  },
  \"task\": {
    \"type\": \"{{ task_type }}\",
    \"index\": \"{{ task_id }}\"
  }
}
{%- endmacro -%}

{% for job in ["worker", "ps", "evaluator", "tensorboard"] -%}
{%- for i in range(replicas[job]) -%}
kind: Service
apiVersion: v1
metadata:
  name: {{ name }}-{{ job }}-{{ i }}
spec:
  type: LoadBalancer
  selector:
    name: {{ name }}
    job: {{ job }}
    task: "{{ i }}"
  ports:
  - port: {{ port }}
---
kind: ReplicationController
apiVersion: v1
metadata:
  name: {{ name }}-{{ job }}-{{ i }}
spec:
  replicas: 1
  template:
    metadata:
      labels:
        name: {{ name }}
        job: {{ job }}
        task: "{{ i }}"
    spec:
      containers:
{% if job == "tensorboard" %}
      - name: tensorflow
        image: tensorflow/tensorflow
{% else %}
      - name: tensorflow
        image: {{ image }}
        resources:
          limits:
            nvidia.com/gpu: {{ num_gpus_per_worker }}
{% endif %}
        env:
{% if job != "tensorboard" %}
        - name: TF_CONFIG
          value: "{{ tf_config(job, i) }}"
{% endif %}
        ports:
        - containerPort: {{ port }}
{% if job == "tensorboard" %}
        command:
        - "tensorboard"
        args:
        - "--logdir={{ train_dir }}"
        - "--port={{ port }}"
{% else %}
        command:
        - "/usr/bin/python"
        - "{{ script }}"
        {%- for cmdline_arg in cmdline_arg_list %}
        - "{{ cmdline_arg }}"
        {%- endfor -%}
      #{{'\n'}}
      restartPolicy: Never
{% endif %}
---
{% endfor %}
{%- endfor -%}